# PII and Sensitive Data Management

**Document Version**: 1.0  
**Last Updated**: 2026-01-08

## Overview

This document describes how Personally Identifiable Information (PII) and sensitive data is handled within the DIY Accounting Submit application. It covers data reception, generation, storage, protection mechanisms, and recommendations for security uplift.

## Table of Contents

1. [Data Received from External Sources](#data-received-from-external-sources)
2. [Data Generated Internally](#data-generated-internally)
3. [Storage Locations](#storage-locations)
4. [Protection Mechanisms](#protection-mechanisms)
5. [Recommendations for Further Uplift](#recommendations-for-further-uplift)

---

## Data Received from External Sources

### 1. User Credentials (Cognito Authentication)

**Source**: Web form submissions during user registration and login  
**Data Types**:
- Email address
- Password (during registration/login only, not stored)
- User profile information

**Protection**:
- Passwords are never stored in the application
- Passwords handled by AWS Cognito (managed service)
- Email addresses stored in Cognito User Pool
- JWT tokens issued after successful authentication

### 2. HMRC Test Credentials (Sandbox Testing)

**Source**: Environment variables, test configuration  
**Data Types**:
- `TEST_HMRC_USERNAME` - HMRC test user ID
- `TEST_HMRC_PASSWORD` - HMRC test user password
- `TEST_HMRC_VAT_NUMBER` - Test VAT registration number

**Protection**:
- **Masked in logs and DynamoDB**: The `hmrcTestPassword` field is automatically masked as `***MASKED***` before persistence
- Only used in test/sandbox environments
- Never used in production
- Stored in environment variables, never committed to code

### 3. HMRC OAuth Tokens

**Source**: HMRC OAuth2 API responses  
**Data Types**:
- `access_token` - Short-lived access token for HMRC API
- `refresh_token` - Long-lived refresh token for obtaining new access tokens
- `Authorization` header - Bearer token in HTTP requests

**Protection**:
- **Masked in DynamoDB**: All tokens are automatically masked as `***MASKED***` before being stored in the HMRC API request audit trail
- Short TTL (4 hours for access tokens)
- Tokens never logged in plaintext
- HTTPS/TLS for all HMRC API communication

### 4. HMRC Client Secrets

**Source**: AWS Secrets Manager (configured manually)  
**Data Types**:
- `HMRC_CLIENT_SECRET` - Production HMRC OAuth2 client secret
- `HMRC_SANDBOX_CLIENT_SECRET` - Sandbox HMRC OAuth2 client secret

**Protection**:
- **Stored in AWS Secrets Manager**, not in code or environment files
- Retrieved at runtime via ARN references
- **Masked in DynamoDB**: The `client_secret` field is automatically masked when auditing token exchange requests
- Encrypted at rest and in transit
- IAM policies restrict access to Lambda execution roles only

### 5. User VAT Submission Data

**Source**: Web form submissions  
**Data Types**:
- VAT Registration Number (VRN)
- Period keys (e.g., "24A1")
- VAT return figures (sales, purchases, VAT amounts)
- Submission dates

**Protection**:
- Stored in DynamoDB with encryption at rest
- User sub (subject identifier) is hashed before storage using SHA-256 with salt
- TTL applied to temporary data (automatic cleanup)
- IAM policies enforce least privilege access

### 6. Fraud Prevention Headers

**Source**: Browser/client metadata collected per HMRC requirements  
**Data Types**:
- IP addresses (public and vendor)
- Device identifiers
- Browser user agent strings
- Screen resolution and window size
- Connection method
- Multi-factor authentication flags
- Timezone information

**Protection**:
- Stored in DynamoDB with encryption at rest
- Required by HMRC for fraud prevention (regulatory compliance)
- Not considered highly sensitive (metadata, not credentials)
- TTL applied for automatic cleanup

---

## Data Generated Internally

### 1. User Subject Identifiers

**Generated By**: AWS Cognito  
**Data Type**: UUID-format subject identifier (sub)

**Protection**:
- **Hashed before DynamoDB storage** using SHA-256 with a salt (`USER_SUB_HASH_SALT`)
- Original `sub` used for Cognito queries, hashed version (`hashedSub`) used for DynamoDB partition keys
- Salt stored in environment variables (`.env.ci`, `.env.prod`)
- Prevents linking user identity across data breaches

### 2. AWS Cognito JWT Tokens

**Generated By**: AWS Cognito User Pool  
**Data Types**:
- ID Token (contains user claims: sub, email, username)
- Access Token (for API authorization)
- Refresh Token (for obtaining new tokens)

**Protection**:
- Short-lived (configurable, typically 1 hour for access/ID tokens)
- Verified using AWS Cognito JWT Verifier in custom authorizer
- Transmitted via HTTPS only
- Stored in browser localStorage (client-side, not server-side)

### 3. Session and Correlation Identifiers

**Generated By**: Application request handling  
**Data Types**:
- `requestId` - Unique identifier for each Lambda request
- `correlationId` - Identifier for tracing requests across services
- `amznTraceId` - AWS X-Ray trace ID
- `traceparent` - W3C Trace Context header

**Protection**:
- Not considered sensitive (used for logging and tracing only)
- No PII contained in these identifiers
- Logged for debugging and observability

### 4. Bundle Identifiers and Entitlements

**Generated By**: Bundle management service  
**Data Types**:
- Bundle IDs (UUIDs)
- Product catalog entries
- Entitlement flags (e.g., VAT submission enabled)

**Protection**:
- Stored in DynamoDB with encryption at rest
- Linked to hashed user subject identifier
- No PII contained (business logic only)

---

## Storage Locations

### 1. DynamoDB Tables

**Tables**:
- `{env}-submit-bundles` - User bundle entitlements
- `{env}-submit-receipts` - VAT submission receipts
- `{env}-submit-hmrc-api-requests` - Audit trail of HMRC API requests/responses
- `{env}-submit-async-requests` - Asynchronous request tracking
- `{env}-submit-hmrc-vat-*-async-requests` - VAT operation async tracking

**Protection**:
- **Encryption at rest** (AWS managed keys)
- **Sensitive data masking**: Passwords, tokens, secrets automatically masked in `hmrc-api-requests` table (see `app/lib/dataMasking.js`)
- **User sub hashing**: All partition keys use `hashedSub` instead of plaintext `sub`
- **TTL**: Items automatically deleted after 30 days (receipts, API requests)
- **IAM policies**: Least privilege access (Lambda execution roles only)
- **VPC endpoints**: DynamoDB access via private network (no public internet)

**Sensitive Fields Masked**:
- `hmrcTestPassword`
- `Authorization` headers
- `access_token`
- `refresh_token`
- `client_secret`
- Any field matching patterns: `*password`, `*secret`, `*token` (with exceptions for metadata fields)

### 2. CloudWatch Logs

**Log Groups**:
- `/aws/lambda/{env}-submit-*` - Lambda function logs
- `/aws/apigateway/{env}-submit-api` - API Gateway access logs

**Protection**:
- Structured logging with Pino (JSON format)
- **Sensitive data redaction**: Tokens and passwords logged with truncated prefixes only (e.g., "Bearer test-tok...")
- Encrypted at rest
- Retention period: Configurable (typically 30 days for non-prod, longer for prod)
- IAM policies restrict access to operations teams

**Note**: While logging attempts to avoid sensitive data, the new masking layer in DynamoDB provides an additional layer of defense-in-depth.

### 3. AWS Secrets Manager

**Secrets Stored**:
- HMRC client secrets (production and sandbox)
- Future: Database credentials, API keys (if needed)

**Protection**:
- **Encryption at rest** (AWS managed keys, KMS)
- **Encryption in transit** (TLS)
- **Versioning**: Secret rotation support
- **IAM policies**: Least privilege access (Lambda execution roles only)
- **Audit trail**: CloudTrail logs all access attempts

### 4. AWS Cognito User Pool

**Data Stored**:
- Email addresses
- Username
- Password hashes (managed by Cognito, never accessible to application)
- User attributes (sub, email_verified, etc.)

**Protection**:
- **Managed service** (AWS handles encryption, security patches)
- **Password policy enforcement** (complexity requirements)
- **MFA support** (optional, configurable)
- **Account recovery** via email
- **No plaintext passwords** stored anywhere

### 5. S3 Buckets

**Buckets**:
- `{env}-submit-dev-bucket` - Deployment artifacts (Docker images, static files)
- CloudFront logs (if enabled)

**Protection**:
- **Encryption at rest** (S3 managed keys)
- **Block public access** enabled
- **Versioning** enabled for deployment buckets
- **IAM policies**: Least privilege access
- **No PII stored** in S3 buckets

### 6. CloudFront (CDN)

**Data**:
- Static web assets (HTML, CSS, JavaScript)
- No PII stored
- Logs may contain IP addresses and user agents

**Protection**:
- **HTTPS only** (HTTP redirected to HTTPS)
- **Encryption in transit** (TLS 1.2+)
- **WAF integration** (optional, not currently enabled)
- **CloudWatch RUM**: Session replay data (opt-in, limited sampling)

---

## Protection Mechanisms

### 1. Encryption

**At Rest**:
- DynamoDB tables: AWS managed encryption keys
- S3 buckets: SSE-S3 (server-side encryption)
- Secrets Manager: KMS encryption
- CloudWatch Logs: Encrypted by default

**In Transit**:
- HTTPS/TLS for all API communication (ALB, API Gateway, CloudFront)
- TLS 1.2+ required
- Certificate management via AWS Certificate Manager

### 2. Data Masking

**Implementation**: `app/lib/dataMasking.js`

**Automatic Masking**: Before persisting HMRC API requests to DynamoDB, sensitive fields are replaced with `***MASKED***`:
- Password fields (e.g., `hmrcTestPassword`, `password`, `userPassword`)
- Authorization headers (e.g., `Authorization: Bearer token`)
- OAuth tokens (e.g., `access_token`, `refresh_token`)
- Client secrets (e.g., `client_secret`, `clientSecret`)

**Pattern Matching**: The masking function uses both exact field name matches and pattern-based detection (e.g., fields ending in "password", "token", "secret") while maintaining an allowlist for non-sensitive fields like `periodKey` and `tokenInfo`.

### 3. Hashing

**User Subject Hashing**: `app/services/subHasher.js`

- SHA-256 with salt
- Salt stored in `USER_SUB_HASH_SALT` environment variable
- Applied to all DynamoDB writes (partition key)
- Prevents correlation attacks across data breaches

### 4. IAM Policies

**Least Privilege**:
- Lambda execution roles have minimal permissions
- DynamoDB: Read/write access to specific tables only
- Secrets Manager: Read access to specific secret ARNs only
- No wildcard resource access (`Resource: "*"`)

**Separation of Concerns**:
- Environment-specific IAM roles
- Self-destruct Lambda has elevated permissions (stack deletion) but protected by separate execution context

### 5. Network Security

**Private Networking**:
- Lambda functions can be placed in VPC (currently not enabled for performance)
- DynamoDB VPC endpoints available (not currently used)
- No direct internet access required for most operations

**API Gateway**:
- Custom authorizer validates JWT tokens before Lambda invocation
- CORS configured for specific origins only
- Rate limiting and throttling (AWS default limits)

### 6. TTL (Time To Live)

**Automatic Data Cleanup**:
- HMRC API requests: 30 days (TTL in DynamoDB)
- Receipts: Configurable TTL
- Async requests: Short TTL (minutes to hours)
- Self-destruct stack: 8 hours for CI environments

---

## Recommendations for Further Uplift

### 1. Field-Level Encryption

**Current State**: Encryption at rest via AWS managed keys (table-level)

**Recommendation**:
- Implement **field-level encryption** for highly sensitive PII fields (e.g., VRN, email addresses)
- Use AWS KMS Customer Managed Keys (CMK) for more granular control
- Consider **client-side encryption** for data that should never be readable by the application backend

**Benefit**: Defense-in-depth; even if DynamoDB is compromised, encrypted fields remain unreadable without specific keys.

### 2. Audit Logging for PII Access

**Current State**: CloudWatch logs capture Lambda execution, but no specific PII access auditing

**Recommendation**:
- Implement **audit trail** for all PII read/write operations
- Log user identity (hashed sub), operation type (read/write/delete), timestamp, and accessed data type
- Store audit logs in separate DynamoDB table or CloudWatch Logs Insights
- Enable **CloudTrail** for all AWS API calls (already enabled, but ensure data events are logged)

**Benefit**: Compliance with GDPR, CCPA, and other privacy regulations; forensic analysis in case of breach.

### 3. Data Retention Policies

**Current State**: TTL configured for some tables, but not comprehensive

**Recommendation**:
- Define **explicit retention policies** for all PII data types
- Automate deletion based on legal/regulatory requirements (e.g., GDPR right to erasure)
- Implement **data archival** for historical data that must be retained for compliance (e.g., tax records)
- Document retention periods in a data governance policy

**Benefit**: Compliance with privacy laws; reduced risk surface by minimizing data storage.

### 4. PII Detection and Classification Automation

**Current State**: Manual identification of sensitive fields

**Recommendation**:
- Use **AWS Macie** (or equivalent) to automatically detect PII in S3 buckets and databases
- Implement **data classification tags** on DynamoDB tables and S3 buckets (e.g., "PII", "Confidential", "Public")
- Create **alerting** for unexpected PII exposure (e.g., PII written to CloudWatch Logs)

**Benefit**: Proactive discovery of PII; prevents accidental exposure; aids in compliance audits.

### 5. Tokenization for HMRC Credentials in Sandbox

**Current State**: Test credentials stored in environment variables, masked in DynamoDB

**Recommendation**:
- Implement **tokenization service** for HMRC test credentials
- Store tokens in Secrets Manager or dedicated tokenization vault
- Application retrieves tokens at runtime, never stores raw credentials

**Benefit**: Additional layer of protection for test credentials; easier credential rotation.

### 6. Monitoring and Alerting for Unauthorized Data Access

**Current State**: CloudWatch metrics for Lambda errors, but no PII-specific alerts

**Recommendation**:
- Set up **CloudWatch Alarms** for:
  - Unauthorized DynamoDB access attempts
  - Unusual query patterns (e.g., full table scans on PII tables)
  - Failed Secrets Manager retrievals
  - Multiple failed authentication attempts
- Integrate with **AWS Security Hub** for centralized security monitoring
- Consider **AWS GuardDuty** for threat detection

**Benefit**: Early detection of security incidents; faster incident response.

### 7. Data Anonymization for Analytics

**Current State**: No analytics on user data currently implemented

**Recommendation**:
- If implementing analytics (e.g., usage metrics, A/B testing), use **anonymized data only**
- Apply **k-anonymity** or **differential privacy** techniques
- Separate analytics pipeline from production data stores

**Benefit**: Enables data-driven insights without exposing PII; compliance with privacy regulations.

### 8. Regular Security Audits and Penetration Testing

**Current State**: No documented security audit schedule

**Recommendation**:
- Conduct **annual security audits** by external third-party
- Perform **penetration testing** on production environment (with appropriate safeguards)
- Implement **bug bounty program** for responsible disclosure
- Review IAM policies and DynamoDB permissions quarterly

**Benefit**: Identifies vulnerabilities before attackers do; demonstrates due diligence to regulators.

### 9. Enhanced Secrets Rotation

**Current State**: Secrets stored in Secrets Manager, but no automatic rotation

**Recommendation**:
- Enable **automatic secret rotation** for HMRC client secrets (if supported by HMRC)
- Implement **rotation Lambda function** to update secrets across environments
- Document secrets rotation procedure and schedule

**Benefit**: Reduces risk of credential compromise; limits blast radius of stolen credentials.

### 10. User Consent Management

**Current State**: No explicit consent management for data collection (fraud prevention headers)

**Recommendation**:
- Implement **consent banner** for GDPR compliance (especially for EU users)
- Allow users to **opt-out** of non-essential data collection (e.g., CloudWatch RUM)
- Document data processing agreements and privacy policy
- Provide **data subject access request** (DSAR) process for users to request their data

**Benefit**: Compliance with GDPR Article 6 (lawful basis) and Article 7 (consent); builds user trust.

---

## Summary

The DIY Accounting Submit application implements multiple layers of protection for PII and sensitive data:

1. **Encryption** at rest and in transit
2. **Data masking** for sensitive fields in audit trails
3. **Hashing** of user identifiers
4. **IAM policies** enforcing least privilege
5. **TTL** for automatic data cleanup
6. **AWS Secrets Manager** for credential storage

Further uplifts should focus on:
- **Field-level encryption** for the most sensitive data
- **Audit logging** for all PII access
- **Automated PII detection** and classification
- **Monitoring and alerting** for security incidents

---

**Document Owner**: Development Team  
**Review Frequency**: Annually or when significant changes are made to data handling  
**Last Review**: 2026-01-08
