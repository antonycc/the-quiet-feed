#!/usr/bin/env node
// SPDX-License-Identifier: AGPL-3.0-only
// Copyright (C) 2025-2026 DIY Accounting Ltd

/**
 * Bundle frontend ES modules for testing
 *
 * This script concatenates all frontend modules into a single bundle file
 * that can be loaded by tests without requiring a module bundler.
 *
 * The bundle exposes all functions on the window object for backward compatibility
 * with existing HTML pages and tests.
 */

import { readFileSync, writeFileSync, existsSync } from "fs";
import { join, dirname } from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const webPublicDir = join(__dirname, "..", "web", "public");

// Order matters: utils first, then services, then main submit.js
const moduleFiles = [
  // Utils layer
  "lib/utils/jwt-utils.js",
  "lib/utils/crypto-utils.js",
  "lib/utils/storage-utils.js",
  "lib/utils/dom-utils.js",
  "lib/utils/correlation-utils.js",
  // Services layer
  "lib/services/auth-service.js",
  "lib/services/api-client.js",
  "lib/services/hmrc-service.js",
  "lib/services/catalog-service.js",
  // Main entry point
  "submit.js",
];

function stripExports(code) {
  // Remove ES module export statements for bundling
  return code
    .replace(/^export\s+\{[^}]*\};?\s*$/gm, "")
    .replace(/^export\s+(default\s+)?(function|const|let|var|class|async\s+function)/gm, "$2");
}

function stripImports(code) {
  // Remove ES module import statements for bundling
  // Handle single-line imports: import { foo } from './bar.js';
  code = code.replace(/^import\s+.*from\s+['"][^'"]+['"];?\s*$/gm, "");
  // Handle multi-line imports: import {\n  foo,\n  bar\n} from './bar.js';
  code = code.replace(/^import\s*\{[\s\S]*?\}\s*from\s*['"][^'"]+['"];?\s*$/gm, "");
  // Handle default imports: import foo from './bar.js';
  code = code.replace(/^import\s+\w+\s+from\s+['"][^'"]+['"];?\s*$/gm, "");
  return code;
}

function bundle() {
  const parts = [];

  parts.push("// Auto-generated bundle for testing - DO NOT EDIT");
  parts.push("// Generated by scripts/bundle-for-tests.js");
  parts.push(`// Generated at: ${new Date().toISOString()}`);
  parts.push("");
  parts.push("(function(window) {");
  parts.push('"use strict";');
  parts.push("");

  for (const moduleFile of moduleFiles) {
    const filePath = join(webPublicDir, moduleFile);

    if (!existsSync(filePath)) {
      console.log(`Skipping ${moduleFile} (not found)`);
      continue;
    }

    let code = readFileSync(filePath, "utf-8");

    // Strip import/export statements for bundling
    code = stripImports(code);
    code = stripExports(code);

    parts.push(`// === ${moduleFile} ===`);
    parts.push(code);
    parts.push("");
  }

  parts.push("})(typeof window !== 'undefined' ? window : globalThis);");
  parts.push("");

  const bundlePath = join(webPublicDir, "submit.bundle.js");
  writeFileSync(bundlePath, parts.join("\n"));
  console.log(`Bundle written to ${bundlePath}`);
}

bundle();
