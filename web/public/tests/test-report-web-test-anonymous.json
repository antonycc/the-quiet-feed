{
  "testName": "web-test-anonymous",
  "generatedAt": "2026-01-11T13:37:42.543Z",
  "testContext": {
    "testId": "web-test-anonymous",
    "name": "Anonymous user: View default feed without login",
    "title": "Anonymous User Feed View",
    "description": "Verifies anonymous users can view the default feed without logging in. Tests SHIELD compliance (explicit pagination, no infinite scroll).",
    "env": {
      "serverPort": "3000",
      "runTestServer": "run"
    },
    "testData": {
      "testUrl": "http://127.0.0.1:3000/",
      "feedItemsVerified": true,
      "shieldCompliant": true
    },
    "artefactsDir": "/Users/antony/projects/the-quiet-feed/target/behaviour-test-results/anonymous.behaviour-Anonym-54f06--default-feed-without-login-anonymousBehaviour",
    "screenshotPath": "target/behaviour-test-results/screenshots/anonymous-behaviour-test",
    "testStartTime": "2026-01-11T13:37:40.737Z"
  },
  "hmrcApiRequests": [],
  "playwrightReport": {
    "exists": true,
    "status": "passed",
    "failedTests": []
  },
  "testSourceFile": {
    "filename": "behaviour-tests/anonymous.behaviour.test.js",
    "content": "// SPDX-License-Identifier: AGPL-3.0-only\n// Copyright (C) 2025-2026 Antony Cartwright\n\n// behaviour-tests/anonymous.behaviour.test.js\n// Anonymous user behaviour test - visits homepage without login, expects default feed\n\nimport { test, expect } from \"@playwright/test\";\nimport fs from \"node:fs\";\nimport path from \"node:path\";\nimport { dotenvConfigIfNotBlank } from \"@app/lib/env.js\";\nimport {\n  addOnPageLogging,\n  getEnvVarAndLog,\n  runLocalHttpServer,\n} from \"./helpers/behaviour-helpers.js\";\n\ndotenvConfigIfNotBlank({ path: \".env\" });\n\nconst screenshotPath = \"target/behaviour-test-results/screenshots/anonymous-behaviour-test\";\n\nconst envFilePath = getEnvVarAndLog(\"envFilePath\", \"DIY_SUBMIT_ENV_FILEPATH\", null);\nconst httpServerPort = getEnvVarAndLog(\"serverPort\", \"TEST_SERVER_HTTP_PORT\", 3000);\nconst runTestServer = getEnvVarAndLog(\"runTestServer\", \"TEST_SERVER_HTTP\", null);\n// For anonymous test, always use local server - no need for ngrok/OAuth\n\nlet serverProcess;\n\n// Timestamp helper for unique screenshot names\nconst timestamp = () => new Date().toISOString().replace(/[:.]/g, \"-\");\n\ntest.setTimeout(120_000);\n\ntest.beforeEach(async ({}, testInfo) => {\n  testInfo.annotations.push({ type: \"test-id\", description: \"web-test-anonymous\" });\n});\n\ntest.beforeAll(async () => {\n  console.log(\"Starting anonymous behaviour test beforeAll hook...\");\n\n  if (!envFilePath) {\n    throw new Error(\"Environment variable DIY_SUBMIT_ENV_FILEPATH is not set\");\n  }\n\n  // Ensure screenshot directory exists\n  fs.mkdirSync(screenshotPath, { recursive: true });\n\n  // Run local HTTP server if configured\n  serverProcess = await runLocalHttpServer(runTestServer, httpServerPort);\n\n  console.log(\"beforeAll hook completed successfully\");\n});\n\ntest.afterAll(async () => {\n  if (serverProcess) {\n    serverProcess.kill();\n  }\n});\n\ntest(\"Anonymous user: View default feed without login\", async ({ page }, testInfo) => {\n  // For anonymous test, always use local HTTP server (no OAuth/ngrok needed)\n  const testUrl = `http://127.0.0.1:${httpServerPort}/`;\n\n  // Add console logging to capture browser messages\n  addOnPageLogging(page);\n\n  // Test artefacts directory\n  const outputDir = testInfo.outputPath(\"\");\n  fs.mkdirSync(outputDir, { recursive: true });\n\n  /* ****************** */\n  /*  GO TO HOME PAGE   */\n  /* ****************** */\n\n  await test.step(\"Navigate to homepage\", async () => {\n    console.log(`[Anonymous Test] Navigating to: ${testUrl}`);\n    await page.goto(testUrl);\n    await page.waitForLoadState(\"networkidle\");\n    await page.screenshot({ path: `${screenshotPath}/01-${timestamp()}-homepage-initial.png` });\n  });\n\n  /* ****************** */\n  /*  VERIFY NOT LOGGED IN  */\n  /* ****************** */\n\n  await test.step(\"Verify not logged in\", async () => {\n    // Check login status shows \"ANONYMOUS\"\n    const loginStatus = page.locator(\"#loginStatus\");\n    await expect(loginStatus).toContainText(\"ANONYMOUS\");\n\n    // Check auth link shows \"ENHANCE\" (not \"SETTINGS\")\n    const authLink = page.locator(\"#authLink\");\n    await expect(authLink).toContainText(\"ENHANCE\");\n\n    await page.screenshot({ path: `${screenshotPath}/02-${timestamp()}-not-logged-in-verified.png` });\n    console.log(\"[Anonymous Test] Verified user is not logged in\");\n  });\n\n  /* ****************** */\n  /*  VERIFY DEFAULT FEED LOADS */\n  /* ****************** */\n\n  await test.step(\"Verify default feed loads\", async () => {\n    // Wait for feed container to have items\n    const feedContainer = page.locator(\"#feedContainer\");\n    await expect(feedContainer).toBeVisible();\n\n    // Wait for spinner to disappear (feed loaded)\n    const spinner = page.locator(\"#feedSpinner\");\n    await expect(spinner).toBeHidden({ timeout: 10000 });\n\n    // Verify feed items are displayed\n    const feedItems = page.locator(\".feed-item\");\n    const itemCount = await feedItems.count();\n    console.log(`[Anonymous Test] Found ${itemCount} feed items`);\n    expect(itemCount).toBeGreaterThan(0);\n\n    await page.screenshot({ path: `${screenshotPath}/03-${timestamp()}-feed-loaded.png` });\n  });\n\n  /* ****************** */\n  /*  VERIFY FEED HEADER */\n  /* ****************** */\n\n  await test.step(\"Verify feed header displays correctly\", async () => {\n    // Check feed name\n    const feedName = page.locator(\"#feedName\");\n    await expect(feedName).toContainText(\"CURATED FEED\");\n\n    // Check item count is displayed\n    const feedCount = page.locator(\"#feedCount\");\n    await expect(feedCount).toContainText(\"items\");\n\n    // Check \"ALL\" source button is active\n    const allButton = page.locator('[data-feed=\"default\"]');\n    await expect(allButton).toHaveClass(/active/);\n\n    await page.screenshot({ path: `${screenshotPath}/04-${timestamp()}-feed-header.png` });\n    console.log(\"[Anonymous Test] Feed header verified\");\n  });\n\n  /* ****************** */\n  /*  VERIFY FEED ITEM STRUCTURE */\n  /* ****************** */\n\n  await test.step(\"Verify feed item structure\", async () => {\n    // Check first feed item has required elements\n    const firstItem = page.locator(\".feed-item\").first();\n    await expect(firstItem).toBeVisible();\n\n    // Verify score is displayed\n    const scoreValue = firstItem.locator(\".score-value\");\n    await expect(scoreValue).toBeVisible();\n    const scoreText = await scoreValue.textContent();\n    const score = parseInt(scoreText, 10);\n    expect(score).toBeGreaterThanOrEqual(0);\n    expect(score).toBeLessThanOrEqual(100);\n    console.log(`[Anonymous Test] First item score: ${score}`);\n\n    // Verify title link exists\n    const titleLink = firstItem.locator(\".feed-item-title a\");\n    await expect(titleLink).toBeVisible();\n\n    // Verify source is displayed\n    const source = firstItem.locator(\".feed-item-source\");\n    await expect(source).toBeVisible();\n\n    await page.screenshot({ path: `${screenshotPath}/05-${timestamp()}-feed-item-structure.png` });\n  });\n\n  /* ****************** */\n  /*  TEST FEED FILTERS */\n  /* ****************** */\n\n  await test.step(\"Test feed filters\", async () => {\n    // Click HIGH SCORE filter\n    const highScoreFilter = page.locator(\".feed-filter\").filter({ hasText: \"HIGH SCORE\" });\n    await highScoreFilter.click();\n    await page.waitForTimeout(500); // Wait for filter to apply\n\n    await page.screenshot({ path: `${screenshotPath}/06-${timestamp()}-high-score-filter.png` });\n\n    // Verify filter is active\n    await expect(highScoreFilter).toHaveClass(/active/);\n\n    // Reset to ALL filter\n    const allFilter = page.locator(\".feed-filter\").filter({ hasText: \"ALL\" });\n    await allFilter.click();\n    await page.waitForTimeout(500);\n\n    console.log(\"[Anonymous Test] Filters tested\");\n  });\n\n  /* ****************** */\n  /*  TEST FEED SOURCE SWITCHING */\n  /* ****************** */\n\n  await test.step(\"Test feed source switching\", async () => {\n    // Click TECH source\n    const techButton = page.locator('[data-feed=\"tech\"]');\n    await techButton.click();\n    await page.waitForTimeout(1000); // Wait for new feed to load\n\n    await page.screenshot({ path: `${screenshotPath}/07-${timestamp()}-tech-feed.png` });\n\n    // Verify TECH is active\n    await expect(techButton).toHaveClass(/active/);\n\n    // Check feed name changed\n    const feedName = page.locator(\"#feedName\");\n    await expect(feedName).toContainText(\"TECH\");\n\n    // Switch back to default\n    const defaultButton = page.locator('[data-feed=\"default\"]');\n    await defaultButton.click();\n    await page.waitForTimeout(1000);\n\n    console.log(\"[Anonymous Test] Feed sources tested\");\n  });\n\n  /* ****************** */\n  /*  TEST LOAD MORE (SHIELD) */\n  /* ****************** */\n\n  await test.step(\"Test SHIELD pagination (Load More)\", async () => {\n    // Check if Load More button exists\n    const loadMoreContainer = page.locator(\"#loadMoreContainer\");\n    const isLoadMoreVisible = await loadMoreContainer.isVisible();\n\n    if (isLoadMoreVisible) {\n      const loadMoreButton = page.locator(\".btn-load-more\");\n      await loadMoreButton.click();\n      await page.waitForTimeout(500);\n\n      await page.screenshot({ path: `${screenshotPath}/08-${timestamp()}-after-load-more.png` });\n      console.log(\"[Anonymous Test] Load More button clicked\");\n    } else {\n      console.log(\"[Anonymous Test] All items already displayed, no Load More needed\");\n    }\n  });\n\n  /* ****************** */\n  /*  FINAL FULL PAGE SCREENSHOT */\n  /* ****************** */\n\n  await test.step(\"Capture final state\", async () => {\n    // Scroll back to top\n    await page.evaluate(() => window.scrollTo(0, 0));\n    await page.waitForTimeout(300);\n\n    await page.screenshot({\n      path: `${screenshotPath}/09-${timestamp()}-final-state.png`,\n      fullPage: true,\n    });\n    console.log(\"[Anonymous Test] Final state captured\");\n  });\n\n  /* ****************** */\n  /*  TEST CONTEXT JSON  */\n  /* ****************** */\n\n  const testContext = {\n    testId: \"web-test-anonymous\",\n    name: testInfo.title,\n    title: \"Anonymous User Feed View\",\n    description: \"Verifies anonymous users can view the default feed without logging in. Tests SHIELD compliance (explicit pagination, no infinite scroll).\",\n    env: {\n      serverPort: httpServerPort,\n      runTestServer,\n    },\n    testData: {\n      testUrl,\n      feedItemsVerified: true,\n      shieldCompliant: true,\n    },\n    artefactsDir: outputDir,\n    screenshotPath,\n    testStartTime: new Date().toISOString(),\n  };\n\n  try {\n    fs.writeFileSync(path.join(outputDir, \"testContext.json\"), JSON.stringify(testContext, null, 2), \"utf-8\");\n  } catch (_e) {\n    console.error(\"[Anonymous Test] Failed to write test context:\", _e);\n  }\n\n  console.log(\"[Anonymous Test] Test completed successfully\");\n});\n"
  },
  "envConfig": {
    "filename": ".env.proxy",
    "content": "# .env.proxy\n#\n# Features:\n#   Proxy configuration which uses ngrok (and expects to be authenticated).\n#   DynamoDB (like) storage.\n#   Mock OAuth2 server.\nDIY_SUBMIT_ENV_FILEPATH=.env.proxy\nDOTENV_CONFIG_QUIET=true\nENVIRONMENT_NAME=proxy\nDEPLOYMENT_NAME=proxy\nDIY_SUBMIT_BASE_URL=https://wanted-finally-anteater.ngrok-free.app/\n\nLOG_TO_CONSOLE=true\nLOG_TO_FILE=true\nCLOUD_TRAIL_ENABLED=\n\nGOOGLE_CLIENT_SECRET_ARN=\nCOGNITO_USER_POOL_ID=\nCOGNITO_CLIENT_ID=\nCOGNITO_BASE_URI=\nUSER_SUB_HASH_SALT=local-development-salt-not-for-production\nBUNDLE_DYNAMODB_TABLE_NAME=test-bundle-table\nSQS_QUEUE_URL=none\n# Local DynamoDB endpoint - set by behaviour tests dynamically via AWS_ENDPOINT_URL_DYNAMODB env var\n# This value is a fallback; tests set the real ephemeral port value\nAWS_ENDPOINT_URL_DYNAMODB=\nACCESS_LOG_GROUP_RETENTION_PERIOD_DAYS=\n\nTEST_SERVER_HTTP_PORT=3000\nTEST_SERVER_HTTP=run\nTEST_PROXY=run\nTEST_MOCK_OAUTH2=run\nTEST_AUTH_PROVIDER=mock\nTEST_AUTH_USERNAME=user\nTEST_AUTH_PASSWORD=\nTEST_DYNAMODB=run\n\nTEST_MFA_ENABLED=true\nTEST_MFA_TYPE=TOTP\nTEST_MFA_TIMESTAMP=2026-01-08T00:09:01Z\n\nTEST_BUNDLE_EXPIRY_DATE=2025-12-31\nTEST_BUNDLE_USER_LIMIT=1000\nTEST_BUNDLE_MOCK=true\n\n#TEST_WIREMOCK=record\n#TEST_WIREMOCK=mock\nWIREMOCK_MOCK_ENVIRONMENT=proxy\nWIREMOCK_PORT=9090\nWIREMOCK_RECORD_OUTPUT_DIR=wiremock-recordings/proxy\n"
  },
  "artifacts": {
    "screenshots": [
      "test-finished-1.png",
      "homepage-initial.png",
      "not-logged-in-verified.png",
      "feed-loaded.png",
      "feed-header.png",
      "feed-item-structure.png",
      "high-score-filter.png",
      "tech-feed.png",
      "after-load-more.png",
      "final-state.png"
    ],
    "videos": [
      "video.webm"
    ],
    "figures": null
  }
}