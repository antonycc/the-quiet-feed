<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>The Quiet Feed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Your feeds, stripped of the garbage. A read-only feed aggregator that surfaces signal from noise." />
    <link rel="stylesheet" href="./submit.css" />
    <!-- CloudWatch RUM configuration placeholders -->
    <meta name="rum:appMonitorId" content="${RUM_APP_MONITOR_ID}" />
    <meta name="rum:region" content="${AWS_REGION}" />
    <meta name="rum:identityPoolId" content="${RUM_IDENTITY_POOL_ID}" />
    <meta name="rum:guestRoleArn" content="${RUM_GUEST_ROLE_ARN}" />
  </head>
  <body>
    <header>
      <div class="header-nav">
        <nav class="nav-links">
          <a href="index.html" class="nav-link" id="navFeed">Feed</a>
          <a href="index.html?feed=about" class="nav-link" id="navAbout">About</a>
          <a href="index.html?feed=settings" class="nav-link" id="navSettings">Settings</a>
        </nav>
        <div class="header-brand">
          <span class="system-prefix">SYSTEM://</span>
          <span class="brand-title">THE QUIET FEED</span>
        </div>
        <div class="auth-section">
          <span class="login-status" id="loginStatus">ANONYMOUS</span>
          <a href="auth/login.html" class="login-link" id="authLink">ENHANCE</a>
        </div>
      </div>
      <p class="subtitle">Your feeds, stripped of the garbage</p>
    </header>

    <main id="mainContent">
      <div id="statusMessagesContainer"></div>

      <!-- Feed Source Selector -->
      <div class="feed-sources" id="feedSources">
        <button class="feed-source-btn active" data-feed="default" onclick="loadFeed('default')">ALL</button>
        <button class="feed-source-btn" data-feed="tech" onclick="loadFeed('tech')">TECH</button>
        <button class="feed-source-btn" data-feed="news" onclick="loadFeed('news')">NEWS</button>
      </div>

      <!-- Feed Header with Filters -->
      <div class="feed-header">
        <div>
          <span id="feedName" style="font-family: var(--font-mono); color: var(--color-accent);">CURATED FEED</span>
          <span id="feedCount" style="color: var(--color-text-secondary); font-size: 0.875rem; margin-left: 0.5rem;"></span>
        </div>
        <div class="feed-filters">
          <button class="feed-filter active" onclick="toggleFilter(this, 'all')">ALL</button>
          <button class="feed-filter" onclick="toggleFilter(this, 'high')">HIGH SCORE</button>
          <button class="feed-filter" onclick="toggleFilter(this, 'wire')">WIRE MODE</button>
        </div>
      </div>

      <!-- Feed Container -->
      <div class="feed-container" id="feedContainer">
        <div class="spinner" id="feedSpinner"></div>
      </div>

      <!-- Load More (SHIELD - explicit pagination, no infinite scroll) -->
      <div class="feed-load-more" id="loadMoreContainer" style="display: none;">
        <button class="btn-load-more" onclick="loadMore()">LOAD MORE</button>
      </div>
    </main>

    <footer>
      <div class="footer-content">
        <div class="footer-left">
          <a href="tests/index.html" target="_blank">tests</a>
          <a href="docs/index.html" target="_blank">api</a>
          <a href="privacy.html">privacy</a>
          <a href="terms.html">terms</a>
        </div>
        <div class="footer-center">
          <p>&copy; 2025-2026 Antony Cartwright</p>
        </div>
        <div class="footer-right" id="localstorageContainer"></div>
      </div>
    </footer>

    <!-- Scripts -->
    <script type="module" src="./submit.js"></script>
    <script src="widgets/auth-status.js"></script>
    <script>
      // Feed state
      let currentFeed = 'default';
      let currentFilter = 'all';
      let feedData = null;
      let displayedItems = 0;
      const ITEMS_PER_PAGE = 10;

      // Initialize
      document.addEventListener('DOMContentLoaded', async () => {
        // Check for feed query param
        const urlParams = new URLSearchParams(window.location.search);
        const feedParam = urlParams.get('feed') || 'default';
        await loadFeed(feedParam);
        checkAuthStatus();
      });

      // Check auth and update UI
      function checkAuthStatus() {
        const idToken = localStorage.getItem('cognitoIdToken');
        const userInfo = localStorage.getItem('userInfo');
        const loginStatus = document.getElementById('loginStatus');
        const authLink = document.getElementById('authLink');

        if (idToken && userInfo) {
          try {
            const user = JSON.parse(userInfo);
            loginStatus.textContent = user.email || 'ENHANCE';
            authLink.textContent = 'SETTINGS';
            authLink.href = 'account/bundles.html';
          } catch (e) {
            console.error('Error parsing user info:', e);
          }
        } else {
          loginStatus.textContent = 'ANONYMOUS';
        }
      }

      // Special feeds that hide the source selector
      const SPECIAL_FEEDS = ['about', 'settings'];

      // Load feed from JSON
      async function loadFeed(feedId) {
        currentFeed = feedId;
        displayedItems = 0;

        // Update nav links
        document.getElementById('navFeed').classList.toggle('active', !SPECIAL_FEEDS.includes(feedId));
        document.getElementById('navAbout').classList.toggle('active', feedId === 'about');
        document.getElementById('navSettings').classList.toggle('active', feedId === 'settings');

        // Show/hide feed sources for special feeds
        const feedSources = document.getElementById('feedSources');
        const feedFilters = document.querySelector('.feed-filters');
        if (SPECIAL_FEEDS.includes(feedId)) {
          feedSources.style.display = 'none';
          if (feedFilters) feedFilters.style.display = 'none';
        } else {
          feedSources.style.display = 'flex';
          if (feedFilters) feedFilters.style.display = 'flex';
        }

        // Update active source button
        document.querySelectorAll('.feed-source-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.feed === feedId);
        });

        // Show spinner (recreate if needed since innerHTML clears it)
        const container = document.getElementById('feedContainer');
        container.innerHTML = '<div class="spinner" id="feedSpinner"></div>';
        const spinner = document.getElementById('feedSpinner');
        spinner.style.display = 'block';

        try {
          const response = await fetch(`./sample-feeds/${feedId}.json`);
          if (!response.ok) throw new Error('Feed not found');

          feedData = await response.json();

          // Update header
          document.getElementById('feedName').textContent = feedData.name.toUpperCase();
          document.getElementById('feedCount').textContent = `${feedData.itemCount} items`;

          // Render initial items
          renderFeedItems();

        } catch (error) {
          console.error('Error loading feed:', error);
          container.innerHTML = `
            <div class="status-message status-error">
              <div class="status-message-content">Unable to load feed. Please try again.</div>
            </div>
          `;
        }
      }

      // Render feed items
      function renderFeedItems() {
        const container = document.getElementById('feedContainer');
        const spinner = document.getElementById('feedSpinner');
        if (spinner) spinner.style.display = 'none';

        if (!feedData || !feedData.items) {
          container.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">No items to display.</p>';
          return;
        }

        // Filter items
        let items = feedData.items;
        if (currentFilter === 'high') {
          items = items.filter(item => item.score >= 75);
        } else if (currentFilter === 'wire') {
          items = items.filter(item => item.wireMode);
        }

        // Get items to display
        const endIndex = Math.min(displayedItems + ITEMS_PER_PAGE, items.length);
        const itemsToShow = items.slice(displayedItems, endIndex);

        // Render items
        itemsToShow.forEach(item => {
          container.appendChild(createFeedItem(item));
        });

        displayedItems = endIndex;

        // Show/hide load more
        const loadMoreContainer = document.getElementById('loadMoreContainer');
        loadMoreContainer.style.display = displayedItems < items.length ? 'block' : 'none';
      }

      // Create feed item element
      function createFeedItem(item) {
        const article = document.createElement('article');
        article.className = 'feed-item';
        article.setAttribute('data-score', item.score || 0);
        article.setAttribute('data-id', item.id);
        if (item.type) article.setAttribute('data-type', item.type);

        // Score display - handle info/action types differently
        let scoreHtml;
        if (item.type === 'info') {
          scoreHtml = `
            <div class="feed-item-score score-info">
              <span class="score-value">ℹ</span>
              <span class="score-label">INFO</span>
            </div>`;
        } else if (item.type === 'action') {
          scoreHtml = `
            <div class="feed-item-score score-action">
              <span class="score-value">→</span>
              <span class="score-label">GO</span>
            </div>`;
        } else {
          // Regular scored article
          const scoreClass = item.score >= 80 ? 'score-high' : item.score >= 50 ? 'score-medium' : 'score-low';
          scoreHtml = `
            <div class="feed-item-score">
              <span class="score-value ${scoreClass}">${item.score}</span>
              <span class="score-label">SCORE</span>
            </div>`;
        }

        // Legacy score class for backwards compatibility
        const scoreClass = item.score >= 80 ? 'score-high' : item.score >= 50 ? 'score-medium' : 'score-low';

        // Time ago
        const timeAgo = getTimeAgo(new Date(item.publishedAt));

        // Tags HTML
        const tagsHtml = item.tags ? item.tags.map(tag =>
          `<span class="feed-tag">${tag}</span>`
        ).join('') : '';

        // Wire mode indicator
        const wireModeHtml = item.wireMode ?
          `<span class="feed-tag tag-wire">WIRE MODE</span>` : '';

        // Dedup indicator
        const dedupHtml = item.dedup ?
          `<span class="feed-tag tag-dedup">${item.dedup.count} SHARES</span>` : '';

        // Demoted indicator
        const demotedHtml = item.demoted ?
          `<span class="feed-tag" style="background: #fee2e2; color: #991b1b;">DEMOTED</span>` : '';

        // Video thumbnail
        const mediaHtml = item.mediaType === 'video' ?
          `<div style="margin-top: 0.75rem; position: relative;">
            <img src="${item.thumbnailUrl}" alt="Video thumbnail" style="width: 100%; max-width: 320px; border-radius: 4px; opacity: 0.9;" />
            <span style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem; font-family: var(--font-mono);">${item.duration}</span>
          </div>` : '';

        // Original title for wire mode
        const originalTitleHtml = item.originalTitle ?
          `<p style="font-size: 0.75rem; color: var(--color-text-secondary); font-style: italic; margin-top: 0.25rem;">
            Original: "${item.originalTitle}"
          </p>` : '';

        article.innerHTML = `
          <div class="feed-item-header">
            <div class="feed-item-content">
              <h3 class="feed-item-title">
                <a href="${item.url}" target="_blank" rel="noopener">${item.title}</a>
              </h3>
              ${originalTitleHtml}
              <div class="feed-item-meta">
                <span class="feed-item-source">${item.source}</span>
                <span class="feed-item-time">${timeAgo}</span>
                ${item.author ? `<span>by ${item.author}</span>` : ''}
              </div>
            </div>
            ${scoreHtml}
          </div>
          <p class="feed-item-excerpt">${item.excerpt}</p>
          ${mediaHtml}
          <div class="feed-item-tags">
            ${tagsHtml}
            ${wireModeHtml}
            ${dedupHtml}
            ${demotedHtml}
          </div>
          <div class="feed-item-actions">
            <button class="feed-action" onclick="muteItem('${item.id}')">MUTE</button>
            <button class="feed-action" onclick="traceItem('${item.id}')">TRACE</button>
            ${item.dedup ? `<button class="feed-action" onclick="expandDedup('${item.id}')">EXPAND</button>` : ''}
          </div>
        `;

        return article;
      }

      // Time ago helper
      function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
      }

      // Load more (SHIELD - explicit action required)
      function loadMore() {
        renderFeedItems();
      }

      // Toggle filter
      function toggleFilter(btn, filter) {
        currentFilter = filter;
        displayedItems = 0;

        document.querySelectorAll('.feed-filter').forEach(f => f.classList.remove('active'));
        btn.classList.add('active');

        const container = document.getElementById('feedContainer');
        container.innerHTML = '';
        renderFeedItems();
      }

      // Placeholder actions - reference tiers not pricing
      function muteItem(id) {
        alert('MUTE: Sign in to ENHANCE your feed with mute controls.');
      }

      function traceItem(id) {
        alert('TRACE: Origin tracking coming soon.');
      }

      function expandDedup(id) {
        alert('DEDUP: Expand similar items coming soon.');
      }
    </script>
  </body>
</html>
