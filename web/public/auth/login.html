<!-- auth/login.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ENHANCE - The Quiet Feed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../submit.css" />
    <meta name="rum:appMonitorId" content="${RUM_APP_MONITOR_ID}" />
    <meta name="rum:region" content="${AWS_REGION}" />
    <meta name="rum:identityPoolId" content="${RUM_IDENTITY_POOL_ID}" />
    <meta name="rum:guestRoleArn" content="${RUM_GUEST_ROLE_ARN}" />
  </head>
  <body>
    <header>
      <div class="header-nav">
        <nav class="nav-links">
          <a href="../index.html" class="nav-link">Feed</a>
          <a href="../index.html?feed=about" class="nav-link">About</a>
          <a href="../index.html?feed=settings" class="nav-link">Settings</a>
        </nav>
        <div class="header-brand">
          <span class="system-prefix">SYSTEM://</span>
          <span class="brand-title">THE QUIET FEED</span>
        </div>
        <div class="auth-section">
          <span class="login-status" id="loginStatus">ANONYMOUS</span>
          <a href="../index.html" class="login-link" id="authLink">Home</a>
        </div>
      </div>
      <p class="subtitle">Sign in to ENHANCE your feed</p>
    </header>

    <main id="mainContent">
      <div id="statusMessagesContainer"></div>

      <div class="form-container" style="text-align: center">
        <h2>ENHANCE</h2>
        <p>Connect your feed sources and unlock personalized scoring</p>

        <div class="auth-providers">
          <div class="auth-provider">
            <button type="button" class="btn auth-btn google-btn" id="loginWithCognito">
              <img src="../images/g-logo.png" alt="Google" class="provider-logo" />
              Continue with Google
            </button>
          </div>

          <div class="auth-provider" id="mockOAuth2Provider">
            <button type="button" class="btn auth-btn" id="loginWithMockOAuth2">
              <img src="https://avatars.githubusercontent.com/u/11848947?s=48&v=4" alt="mock-oauth2-server" class="provider-logo" />
              Continue with mock-oauth2-server
            </button>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <div class="footer-content">
        <div class="footer-left">
          <a href="../tests/index.html" target="_blank">tests</a>
          <a href="../docs/index.html" target="_blank">api</a>
          <a href="../privacy.html">privacy</a>
          <a href="../terms.html">terms</a>
        </div>
        <div class="footer-center">
          <p>&copy; 2025-2026 Antony Cartwright</p>
        </div>
        <div class="footer-right" id="localstorageContainer"></div>
      </div>
    </footer>

    <script src="../lib/env-loader.js"></script>
    <script src="../lib/auth-url-builder.js"></script>
    <script type="module" src="../submit.js"></script>
    <script src="../lib/request-cache.js"></script>
    <script src="../lib/toml-parser.js"></script>
    <script src="../widgets/status-messages.js"></script>
    <script src="../widgets/auth-status.js"></script>
    <script src="../widgets/localstorage-viewer.js"></script>
    <script>
      (async function () {
        try {
          await window.loadEnv();
        } catch (err) {
          console.warn("Failed to load environment:", err);
        }
      })();

      async function loginWithCognito() {
        console.log("Initiating login with Google via Cognito");

        localStorage.removeItem("authState");
        localStorage.removeItem("cognitoAccessToken");
        localStorage.removeItem("cognitoIdToken");
        localStorage.removeItem("cognitoRefreshToken");
        localStorage.removeItem("userInfo");

        const state = Math.random().toString(36).substring(2, 15);
        localStorage.setItem("authState", state);

        let authResponseUrl;
        if (window.__env && window.authUrlBuilder) {
          authResponseUrl = window.authUrlBuilder.buildCognitoAuthUrl(state);
        } else {
          const authResponse = await getAuthUrl(state, "cognito");
          authResponseUrl = authResponse.authUrl;
        }

        try {
          window.__correlation?.prepareRedirect?.();
        } catch {}
        window.location.href = authResponseUrl;
      }

      async function loginWithMockOAuth2() {
        console.log("Initiating mock-oauth2-server login");

        localStorage.removeItem("cognitoAccessToken");
        localStorage.removeItem("cognitoIdToken");
        localStorage.removeItem("cognitoRefreshToken");
        localStorage.removeItem("userInfo");
        localStorage.removeItem("authState");

        const state = Math.random().toString(36).substring(2, 15);
        localStorage.setItem("authState", state);

        const authResponse = await getAuthUrl(state, "mock");
        const authUrl = authResponse.authUrl;

        showStatus(`Redirecting to ${authUrl}`, "info");
        try {
          window.__correlation?.prepareRedirect?.();
        } catch {}
        window.location.href = authUrl;
      }

      function checkExistingAuth() {
        const accessToken = localStorage.getItem("cognitoAccessToken");
        const userInfo = localStorage.getItem("userInfo");

        if (accessToken && userInfo) {
          console.log("User already authenticated");
          updateLoginStatus();
        }
      }

      const loginWithCognitoButton = document.getElementById("loginWithCognito");
      const loginWithMockOAuth2Button = document.getElementById("loginWithMockOAuth2");

      loginWithCognitoButton.onclick = loginWithCognito;
      loginWithMockOAuth2Button.addEventListener("click", async (event) => {
        event.preventDefault();
        await loginWithMockOAuth2();
      });

      sessionStorage.removeItem("currentActivity");
      checkExistingAuth();
    </script>
  </body>
</html>
