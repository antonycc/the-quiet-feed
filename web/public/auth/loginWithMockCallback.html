<!-- loginWithMockCallback.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DIY Accounting Submit - Login with mock callback</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../submit.css" />
    <!-- CloudWatch RUM configuration placeholders; replace values during deployment -->
    <meta name="rum:appMonitorId" content="${RUM_APP_MONITOR_ID}" />
    <meta name="rum:region" content="${AWS_REGION}" />
    <meta name="rum:identityPoolId" content="${RUM_IDENTITY_POOL_ID}" />
    <meta name="rum:guestRoleArn" content="${RUM_GUEST_ROLE_ARN}" />
  </head>
  <body>
    <header>
      <div class="header-nav">
        <div class="hamburger-menu">
          <button class="hamburger-btn" onclick="toggleMenu()">â˜°</button>
          <div class="menu-dropdown" id="menuDropdown">
            <a href="../index.html">Home</a>
            <a href="../account/bundles.html">Bundles</a>
            <a href="../hmrc/receipt/receipts.html">Receipts</a>
            <a href="../guide/index.html">User Guide</a>
            <a href="../about.html">About</a>
          </div>
        </div>
        <div class="auth-section">
          <span class="entitlement-status">Activity: unrestricted</span>
          <span class="login-status">Not logged in</span>
          <a href="../auth/login.html" class="login-link">Log in</a>
        </div>
      </div>
      <h1>DIY Accounting Submit - Login with mock callback</h1>
      <p class="subtitle">Submit UK VAT returns to HMRC under Making Tax Digital (MTD)</p>
    </header>

    <div id="mainContent">
      <div id="statusMessagesContainer"></div>

      <div id="loadingSpinner" class="spinner" style="display: none"></div>

      <div class="form-container" style="text-align: center">
        <h2 id="welcomeHeading">Welcome</h2>
        <p>Return home.</p>
        <button type="button" class="btn" onclick="window.location.href = '../index.html'">Home</button>
      </div>
    </div>

    <footer>
      <div class="footer-left">
        <a href="#" id="viewSourceLink" style="display: none">view source</a>
        <a id="latestTestsLink" style="display: inline" target="_blank" href="tests/index.html">tests</a>
        <a id="apiDocsLink" style="display: inline" target="_blank" href="./docs/index.html"> api </a>
      </div>
      <div class="footer-content">
        <div class="footer-center">
          <p>&copy; 2025 DIY Accounting Limited</p>
        </div>
      </div>
    </footer>

    <script type="module" src="../submit.js"></script>
    <script src="../lib/request-cache.js"></script>
    <script src="../lib/toml-parser.js"></script>
    <script src="../widgets/hamburger-menu.js"></script>
    <script src="../widgets/entitlement-status.js"></script>
    <script src="../widgets/auth-status.js"></script>
    <script src="../widgets/status-messages.js"></script>
    <script src="../widgets/loading-spinner.js"></script>
    <script>
      // Check for authentication callback
      function checkAuthCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");
        const state = urlParams.get("state");

        if (code) {
          console.log("Authentication callback received with code:", code);
          handleAuthCallback(code, state);
        }
      }

      function base64UrlDecode(str) {
        // Replace URL-safe chars
        str = str.replace(/-/g, "+").replace(/_/g, "/");
        // Add padding if missing
        const pad = str.length % 4;
        if (pad) {
          str += "=".repeat(4 - pad);
        }
        return atob(str);
      }

      // Handle authentication callback from mock
      async function handleAuthCallback(code, state) {
        try {
          showLoading();
          showStatus("Exchanging authorization code for access token...", "info");
          // Exchange authorization code for tokens via same-origin proxy to avoid PNA/CORS
          const tokenResponse = await fetch(`/api/v1/mock/token`, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({
              grant_type: "authorization_code",
              client_id: "debugger",
              code: code,
              // Use the current origin so it matches the authorize redirect_uri
              redirect_uri: `${window.location.origin}/auth/loginWithMockCallback.html`,
            }),
          });

          if (!tokenResponse.ok) {
            throw new Error("Failed to exchange authorization code for tokens");
          }

          const tokens = await tokenResponse.json();
          console.log("Received tokens from mock " + JSON.stringify(tokens));

          // Store tokens in localStorage
          if (tokens.access_token) {
            localStorage.setItem("cognitoAccessToken", tokens.access_token);
          }
          if (tokens.id_token) {
            localStorage.setItem("cognitoIdToken", tokens.id_token);
          }
          if (tokens.refresh_token) {
            localStorage.setItem("cognitoRefreshToken", tokens.refresh_token);
          }

          // Decode ID token to get user info
          const base64Payload = tokens.id_token.split(".")[1];
          const jsonPayload = base64UrlDecode(base64Payload);
          const idTokenPayload = JSON.parse(jsonPayload);

          console.log("Received id_token from mock " + JSON.stringify(idTokenPayload));

          localStorage.setItem(
            "userInfo",
            JSON.stringify({
              sub: idTokenPayload.sub,
              email: idTokenPayload.email,
              given_name: idTokenPayload.given_name,
              family_name: idTokenPayload.family_name,
            }),
          );

          console.log("User authenticated successfully using mock:", idTokenPayload.email);

          // Extract MFA status from amr (Authentication Methods Reference) claim
          // Mock OAuth server can include amr claims to simulate MFA (e.g., ["mfa", "pwd"])
          const amrClaims = idTokenPayload.amr || [];
          const mfaIndicators = ["mfa", "swk", "hwk", "otp"]; // mfa=multi-factor, swk=software key, hwk=hardware key, otp=one-time password
          const hasMFA = Array.isArray(amrClaims) && amrClaims.some((method) => mfaIndicators.includes(method));

          if (hasMFA) {
            // Store MFA metadata for use in fraud prevention headers
            const mfaMetadata = {
              type: "OTHER", // Use OTHER for federated IdP MFA (mock simulates Google 2FA, etc.)
              timestamp: new Date().toISOString(),
              uniqueReference: crypto.randomUUID(),
            };
            sessionStorage.setItem("mfaMetadata", JSON.stringify(mfaMetadata));
            console.log("MFA detected from mock IdP:", amrClaims, "Stored metadata:", mfaMetadata);
          } else {
            // No MFA detected - remove any existing metadata
            sessionStorage.removeItem("mfaMetadata");
            console.log("No MFA detected in mock amr claims:", amrClaims);
          }

          showStatus("Authenticated successfully. Fetching bundles...", "info");

          // No longer store bundles in localStorage; bundles will be fetched by pages as needed from /api/v1/bundle
          showStatus("Authenticated successfully. Redirecting...", "info");

          // Clear URL parameters
          window.history.replaceState({}, document.title, window.location.pathname);

          // Redirect to bundles page or home
          window.location.href = "../index.html";
        } catch (error) {
          console.error("Authentication callback error:", error);
          showStatus(`Authentication failed: ${error.message}`, "error");
        } finally {
          hideLoading();
        }
      }

      // Check if this page was loaded as a callback from authentication
      checkAuthCallback();
    </script>
  </body>
</html>
