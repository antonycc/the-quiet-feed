name: test
run-name: "test from ${{ github.ref_name }}"

on:
  workflow_dispatch:
    inputs:
      environment-name:
        type: choice
        description: 'Environment name to use instead of computing from branch, e.g. ci or prod'
        required: false
        options:
          - ''
          - 'ci'
          - 'prod'
        default: ''
      deployment-name:
        type: string
        description: 'Deployment name to use instead of computing from branch, e.g. ci-lambdas6 or prod-ea373de'
        required: false
        default: ''
  workflow_call:
    inputs:
      environment-name:
        type: string
        description: 'Environment name to use instead of computing from branch, e.g. ci or prod'
        required: true
      deployment-name:
        type: string
        description: 'Deployment name to use instead of computing from branch, e.g. ci-lambdas6 or prod-ea373de'
        required: true

  push:
    branches:
      - '**'
      - '!gh_pages'
    paths:
      - 'app/**'
      - 'infra/**'
      - 'tests/**'
      - 'web/**'
      - '.env.ci'
      - '.env.prod'
      - '**/cdk.json'
      - 'Dockerfile'
      - 'LICENSE'
      - 'package.json'
      - 'package-lock.json'
      - 'pom.xml'
      - 'web/public/submit.catalogue.toml'
      - '.github/actions/get-names'
      - '.github/workflows/test.yml'
      - '.prettierignore'
      - '.prettierrc'
      - 'eslint.config.js'
      - 'jsconfig.json'
      - 'mock-oauth2-config.json'
      - 'playwright.config.js'
      - 'vitest.config.js'
  schedule:
    - cron: '23 4 * * *'

permissions:
  contents: read
  packages: read
  id-token: write

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '22'
  ACTIONS_ROLE_ARN: 'arn:aws:iam::887764105431:role/submit-github-actions-role'
  DEPLOY_ROLE_ARN:  'arn:aws:iam::887764105431:role/submit-deployment-role'
  AWS_REGION: 'eu-west-2'
  AWS_ACCOUNT_ID: '887764105431'
  AWS_HOSTED_ZONE_ID: 'Z0315522208PWZSSBI9AL'
  BASE_IMAGE_TAG_PREFIX: 'submit-base'
  loadTestDuration: ${{ inputs.loadTestDuration || '30s' }}
  GITHUB_ACTOR: ${{ github.actor }}
  SELF_DESTRUCT_DELAY_HOURS: ${{ inputs.selfDestructDelayHours || '1' }}
  BASE_IMAGE_TAG: ${{ github.sha }}
  FORCE_ALL_STACK_DEPLOYMENT: ${{ inputs.forceAllStackDeployment || 'false' }}
  COMMIT_HASH: ${{ github.sha }}
  BUILD_NUMBER: ${{ github.run_number }}
  GITHUB_REF: ${{ github.ref }}
  GITHUB_REF_TO_ENV: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}

jobs:

  names:
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Compute deployment name and environment
        id: deployment-config
        uses: ./.github/actions/get-names
        with:
          environment-name: ${{ github.event.inputs.environment-name || '' }}
          deployment-name: ${{ github.event.inputs.deployment-name || '' }}
    outputs:
      environment-name: ${{ steps.deployment-config.outputs.environment-name }}
      deployment-name: ${{ steps.deployment-config.outputs.deployment-name }}
      base-domain: ${{ steps.deployment-config.outputs.base-domain }}
      base-url:      ${{ steps.deployment-config.outputs.base-url }}
      apex-domain: ${{ steps.deployment-config.outputs.apex-domain }}
      apex-url: ${{ steps.deployment-config.outputs.apex-url }}
      holding-domain: ${{ steps.deployment-config.outputs.holding-domain }}
      holding-url: ${{ steps.deployment-config.outputs.holding-url }}

  npm-test:
    name: 'npm test'
    runs-on: ubuntu-24.04
    needs:
      - names
    permissions:
      contents: read
      packages: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - run: npm test

  npm-unit-test:
    name: 'npm unit test'
    runs-on: ubuntu-latest
    needs:
      - names
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - run: npm run test:coverage

  npm-system-test:
    name: 'npm system test'
    runs-on: ubuntu-latest
    needs:
      - names
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - run: npm run test:system

  npm-test-web-unit:
    name: 'npm unit test with coverage'
    runs-on: ubuntu-latest
    needs:
      - names
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci || npm install

      - name: Build bundle for tests
        run: npm run bundle

      - run: npm run test:web-unit

  npm-browser-test:
    name: 'npm browser test'
    runs-on: ubuntu-latest
    needs:
      - names
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - run: npx playwright install chromium --with-deps

      - run: npm run test:browser

  mvn-test:
    name: 'maven test'
    runs-on: ubuntu-latest
    needs:
      - names
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: test
        id: test
        shell: bash
        run: |
          ./mvnw clean test

  npm-test-cdk-ci:
    name: 'npm test cdk-ci'
    needs:
      - names
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        run: npm ci

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: verify
        id: mvn-verify
        shell: bash
        run: |
          ./mvnw clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }}

      - name: Self Destruct Start Datetime (ISO 8601) now plus SELF_DESTRUCT_DELAY_HOURS
        id: self-destruct-start
        shell: bash
        run: |
          SELF_DESTRUCT_START_DATETIME=$(date -u -d "+${{ env.SELF_DESTRUCT_DELAY_HOURS }} hours" +"%Y-%m-%dT%H:%M:%SZ")
          echo "SELF_DESTRUCT_START_DATETIME=$SELF_DESTRUCT_START_DATETIME"
          echo "SELF_DESTRUCT_START_DATETIME=$SELF_DESTRUCT_START_DATETIME" >> $GITHUB_OUTPUT

      - name: test cdk
        id: test-cdk
        shell: bash
        run: npm run cdk-ci
        env:
          ENVIRONMENT_NAME: 'ci'
          DEPLOYMENT_NAME: 'ci'
          SELF_DESTRUCT_HANDLER_SOURCE: "../${{ steps.mvn-verify.outputs.SELF_DESTRUCT_HANDLER_SOURCE }}"
          SELF_DESTRUCT_START_DATETIME: ${{ steps.self-destruct-start.outputs.SELF_DESTRUCT_START_DATETIME }}
          # Set by deploy-environment.yml after the environment's AuthStack is deployed
          COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
          COGNITO_CLIENT_ID: ${{ vars.COGNITO_CLIENT_ID }}

  npm-test-cdk-prod:
    name: 'npm test cdk prod'
    needs:
      - names
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        run: npm ci

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: verify
        id: mvn-verify
        shell: bash
        run: |
          ./mvnw clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }}

      - name: Self Destruct Start Datetime (ISO 8601) now plus SELF_DESTRUCT_DELAY_HOURS
        id: self-destruct-start
        shell: bash
        run: |
          SELF_DESTRUCT_START_DATETIME=$(date -u -d "+${{ env.SELF_DESTRUCT_DELAY_HOURS }} hours" +"%Y-%m-%dT%H:%M:%SZ")
          echo "SELF_DESTRUCT_START_DATETIME=$SELF_DESTRUCT_START_DATETIME"
          echo "SELF_DESTRUCT_START_DATETIME=$SELF_DESTRUCT_START_DATETIME" >> $GITHUB_OUTPUT

      - name: test cdk
        id: test-cdk
        shell: bash
        run: npm run cdk
        env:
          ENVIRONMENT_NAME: 'prod'
          DEPLOYMENT_NAME: 'prod'
          SELF_DESTRUCT_START_DATETIME: ${{ steps.self-destruct-start.outputs.SELF_DESTRUCT_START_DATETIME }}
          # Set by deploy-environment.yml after the environment's AuthStack is deployed
          COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
          COGNITO_CLIENT_ID: ${{ vars.COGNITO_CLIENT_ID }}

  # ========================================
  # Behaviour Tests (using mkcert + local HTTPS)
  # ========================================

  behaviour-test-anonymous:
    name: 'Behaviour: Anonymous'
    runs-on: ubuntu-latest
    needs:
      - npm-test
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: Install mkcert
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3-tools
          curl -JLO "https://dl.filippo.io/mkcert/latest?for=linux/amd64"
          chmod +x mkcert-v*-linux-amd64
          sudo mv mkcert-v*-linux-amd64 /usr/local/bin/mkcert

      - name: Setup mkcert CA and certificates
        run: |
          mkcert -install
          mkdir -p .certs
          mkcert -cert-file .certs/server.crt -key-file .certs/server.key local.thequietfeed.com localhost 127.0.0.1

      - name: Add local.thequietfeed.com to /etc/hosts
        run: |
          echo "127.0.0.1 local.thequietfeed.com" | sudo tee -a /etc/hosts

      - name: Install Playwright
        run: npx playwright install chromium --with-deps

      - name: Run anonymous behaviour tests
        run: npm run test:anonymousBehaviour-proxy
        env:
          USE_HTTPS: 'true'
          CI: 'true'

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: behaviour-anonymous-results
          path: |
            target/behaviour-test-results/
            test-results/
          retention-days: 7

  behaviour-test-auth:
    name: 'Behaviour: Auth'
    runs-on: ubuntu-latest
    needs:
      - npm-test
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: Install mkcert
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3-tools
          curl -JLO "https://dl.filippo.io/mkcert/latest?for=linux/amd64"
          chmod +x mkcert-v*-linux-amd64
          sudo mv mkcert-v*-linux-amd64 /usr/local/bin/mkcert

      - name: Setup mkcert CA and certificates
        run: |
          mkcert -install
          mkdir -p .certs
          mkcert -cert-file .certs/server.crt -key-file .certs/server.key local.thequietfeed.com localhost 127.0.0.1

      - name: Add local.thequietfeed.com to /etc/hosts
        run: |
          echo "127.0.0.1 local.thequietfeed.com" | sudo tee -a /etc/hosts

      - name: Install Playwright
        run: npx playwright install chromium --with-deps

      - name: Run auth behaviour tests
        run: npm run test:authBehaviour-proxy
        env:
          USE_HTTPS: 'true'
          CI: 'true'

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: behaviour-auth-results
          path: |
            target/behaviour-test-results/
            test-results/
          retention-days: 7

  behaviour-test-bundles:
    name: 'Behaviour: Bundles'
    runs-on: ubuntu-latest
    needs:
      - npm-test
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: Install mkcert
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3-tools
          curl -JLO "https://dl.filippo.io/mkcert/latest?for=linux/amd64"
          chmod +x mkcert-v*-linux-amd64
          sudo mv mkcert-v*-linux-amd64 /usr/local/bin/mkcert

      - name: Setup mkcert CA and certificates
        run: |
          mkcert -install
          mkdir -p .certs
          mkcert -cert-file .certs/server.crt -key-file .certs/server.key local.thequietfeed.com localhost 127.0.0.1

      - name: Add local.thequietfeed.com to /etc/hosts
        run: |
          echo "127.0.0.1 local.thequietfeed.com" | sudo tee -a /etc/hosts

      - name: Install Playwright
        run: npx playwright install chromium --with-deps

      - name: Run bundles behaviour tests
        run: npm run test:bundleBehaviour-proxy
        env:
          USE_HTTPS: 'true'
          CI: 'true'

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: behaviour-bundles-results
          path: |
            target/behaviour-test-results/
            test-results/
          retention-days: 7

  behaviour-test-enhance:
    name: 'Behaviour: Enhance'
    runs-on: ubuntu-latest
    needs:
      - npm-test
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: Install mkcert
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3-tools
          curl -JLO "https://dl.filippo.io/mkcert/latest?for=linux/amd64"
          chmod +x mkcert-v*-linux-amd64
          sudo mv mkcert-v*-linux-amd64 /usr/local/bin/mkcert

      - name: Setup mkcert CA and certificates
        run: |
          mkcert -install
          mkdir -p .certs
          mkcert -cert-file .certs/server.crt -key-file .certs/server.key local.thequietfeed.com localhost 127.0.0.1

      - name: Add local.thequietfeed.com to /etc/hosts
        run: |
          echo "127.0.0.1 local.thequietfeed.com" | sudo tee -a /etc/hosts

      - name: Install Playwright
        run: npx playwright install chromium --with-deps

      - name: Run enhance behaviour tests
        run: npm run test:enhanceBehaviour-proxy
        env:
          USE_HTTPS: 'true'
          CI: 'true'

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: behaviour-enhance-results
          path: |
            target/behaviour-test-results/
            test-results/
          retention-days: 7

  behaviour-test-all:
    name: 'Behaviour: All Combined'
    runs-on: ubuntu-latest
    needs:
      - npm-test
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: Install mkcert
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3-tools
          curl -JLO "https://dl.filippo.io/mkcert/latest?for=linux/amd64"
          chmod +x mkcert-v*-linux-amd64
          sudo mv mkcert-v*-linux-amd64 /usr/local/bin/mkcert

      - name: Setup mkcert CA and certificates
        run: |
          mkcert -install
          mkdir -p .certs
          mkcert -cert-file .certs/server.crt -key-file .certs/server.key local.thequietfeed.com localhost 127.0.0.1

      - name: Add local.thequietfeed.com to /etc/hosts
        run: |
          echo "127.0.0.1 local.thequietfeed.com" | sudo tee -a /etc/hosts

      - name: Install Playwright
        run: npx playwright install chromium --with-deps

      - name: Run all behaviour tests
        run: npm run test:allBehaviour-proxy
        env:
          USE_HTTPS: 'true'
          CI: 'true'

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: behaviour-all-results
          path: |
            target/behaviour-test-results/
            test-results/
          retention-days: 7

  # ========================================
  # Feed Processing Test (LLM validation)
  # ========================================

  feed-processing-test:
    name: 'Feed Processing (LLM)'
    runs-on: ubuntu-latest
    needs:
      - npm-test
    permissions:
      contents: read
      id-token: write
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: Run quick feed processing with LLM
        run: |
          # Run quick feed processing (4 feeds, 1 item each)
          # This validates LLM scoring works but doesn't commit results
          node scripts/process-feeds.js --output target/test-feeds --feeds 4 --depth 1 --score --wire --verbose

      - name: Verify feed output
        run: |
          echo "Checking generated feed files..."
          ls -la target/test-feeds/ || echo "No output directory"
          find target/test-feeds -name "*.json" -exec echo "Found: {}" \; || echo "No JSON files generated"

      - name: Upload processed feeds
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: feed-processing-results
          path: target/test-feeds/
          retention-days: 7
