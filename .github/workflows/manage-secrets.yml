name: manage secrets
run-name: "${{ inputs.action }} secrets for ${{ inputs.environment-name }}"

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        type: choice
        options:
          - 'list'
          - 'check'
          - 'check-salt'
          - 'backup-salt'
          - 'restore-salt'
        required: true
        default: 'check'
      environment-name:
        type: choice
        description: 'Environment'
        required: true
        options:
          - 'ci'
          - 'prod'
      salt-backup-value:
        description: 'Salt value to restore (only for restore-salt action)'
        required: false
        type: string

env:
  ACTIONS_ROLE_ARN: 'arn:aws:iam::887764105431:role/submit-github-actions-role'
  DEPLOY_ROLE_ARN: 'arn:aws:iam::887764105431:role/submit-deployment-role'
  AWS_REGION: 'eu-west-2'

jobs:
  manage:
    name: '${{ inputs.action }} secrets'
    runs-on: ubuntu-24.04
    environment: ${{ inputs.environment-name }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: List all secrets
        if: inputs.action == 'list'
        run: |
          echo "=============================================="
          echo "Secrets for environment: ${{ inputs.environment-name }}"
          echo "=============================================="
          echo ""

          aws secretsmanager list-secrets \
            --filter Key=name,Values="${{ inputs.environment-name }}/submit" \
            --query 'SecretList[].{Name:Name,Created:CreatedDate,Modified:LastChangedDate}' \
            --output table \
            --region ${{ env.AWS_REGION }}

          echo ""
          echo "Note: Use 'check' action to verify secrets have values"

      - name: Check all secrets
        if: inputs.action == 'check'
        run: |
          ENV_NAME="${{ inputs.environment-name }}"

          echo "=============================================="
          echo "Checking all secrets for: $ENV_NAME"
          echo "=============================================="
          echo ""

          # List of required secrets
          SECRETS=(
            "$ENV_NAME/submit/user-sub-hash-salt"
            "$ENV_NAME/submit/google/client_secret"
            "$ENV_NAME/submit/hmrc/client_secret"
            "$ENV_NAME/submit/hmrc/sandbox_client_secret"
          )

          ALL_OK=true

          for SECRET in "${SECRETS[@]}"; do
            echo -n "$SECRET: "

            if aws secretsmanager describe-secret --secret-id "$SECRET" --region ${{ env.AWS_REGION }} 2>/dev/null >/dev/null; then
              # Check if it has a value
              VALUE=$(aws secretsmanager get-secret-value --secret-id "$SECRET" \
                --query 'SecretString' --output text --region ${{ env.AWS_REGION }} 2>/dev/null || echo "")

              if [ -n "$VALUE" ] && [ "$VALUE" != "null" ]; then
                VALUE_LEN=${#VALUE}
                echo "OK (${VALUE_LEN} chars)"
              else
                echo "EMPTY"
                ALL_OK=false
              fi
            else
              echo "MISSING"
              ALL_OK=false
            fi
          done

          echo ""

          if [ "$ALL_OK" = "true" ]; then
            echo "All secrets are present and have values"
          else
            echo "Some secrets are missing or empty!"
            echo "Run 'deploy environment' workflow to create missing secrets."
            exit 1
          fi

      - name: Check salt secret details
        if: inputs.action == 'check-salt'
        run: |
          ENV_NAME="${{ inputs.environment-name }}"
          SECRET_NAME="$ENV_NAME/submit/user-sub-hash-salt"

          echo "=============================================="
          echo "Salt Secret Details: $SECRET_NAME"
          echo "=============================================="
          echo ""

          # Check if secret exists
          if ! aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "SECRET DOES NOT EXIST!"
            echo ""
            echo "To create the salt secret, run the 'deploy environment' workflow."
            exit 1
          fi

          echo "Secret exists"
          echo ""

          # Get metadata
          echo "=== Metadata ==="
          aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${{ env.AWS_REGION }} \
            | jq '{
                Name: .Name,
                ARN: .ARN,
                Created: .CreatedDate,
                LastModified: .LastChangedDate,
                LastAccessed: .LastAccessedDate,
                Tags: .Tags
              }'

          echo ""

          # Check value (without exposing it)
          VALUE=$(aws secretsmanager get-secret-value --secret-id "$SECRET_NAME" \
            --query 'SecretString' --output text --region ${{ env.AWS_REGION }} 2>/dev/null || echo "")

          if [ -n "$VALUE" ] && [ "$VALUE" != "null" ]; then
            VALUE_LEN=${#VALUE}
            echo "=== Value Status ==="
            echo "Has value: YES"
            echo "Value length: $VALUE_LEN characters"

            # Base64-encoded 32-byte salt should be ~44 characters
            if [ $VALUE_LEN -ge 40 ] && [ $VALUE_LEN -le 50 ]; then
              echo "Length check: PASS (expected ~44 for 32-byte base64)"
            else
              echo "Length check: WARNING (unexpected length, expected ~44)"
            fi
          else
            echo "=== Value Status ==="
            echo "Has value: NO"
            echo ""
            echo "The secret exists but has no value. This will cause runtime failures."
            exit 1
          fi

          echo ""
          echo "Salt secret check completed successfully"

      - name: Backup salt value
        if: inputs.action == 'backup-salt'
        run: |
          ENV_NAME="${{ inputs.environment-name }}"
          SECRET_NAME="$ENV_NAME/submit/user-sub-hash-salt"

          echo "=============================================="
          echo "BACKUP: Salt Secret Value"
          echo "=============================================="
          echo ""
          echo "SECRET NAME: $SECRET_NAME"
          echo ""
          echo "========================================================"
          echo "WARNING: The salt value will be displayed below."
          echo "         Store it securely and DELETE THIS WORKFLOW RUN"
          echo "         from the Actions history after copying the value!"
          echo "========================================================"
          echo ""

          # Check if secret exists
          if ! aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${{ env.AWS_REGION }} 2>/dev/null >/dev/null; then
            echo "ERROR: Secret does not exist"
            exit 1
          fi

          # Get the value
          VALUE=$(aws secretsmanager get-secret-value --secret-id "$SECRET_NAME" \
            --query 'SecretString' --output text --region ${{ env.AWS_REGION }} 2>/dev/null || echo "")

          if [ -z "$VALUE" ] || [ "$VALUE" = "null" ]; then
            echo "ERROR: Secret has no value"
            exit 1
          fi

          echo "=== SALT VALUE (COPY THIS) ==="
          echo ""
          echo "$VALUE"
          echo ""
          echo "=== END SALT VALUE ==="
          echo ""
          echo "Instructions:"
          echo "1. Copy the value above"
          echo "2. Store it in a secure location (password manager, encrypted file)"
          echo "3. Go to Actions -> This workflow run -> Delete workflow run"
          echo ""
          echo "To restore this value later, use the 'restore-salt' action"
          echo "with the salt-backup-value input."

      - name: Restore salt value
        if: inputs.action == 'restore-salt'
        run: |
          ENV_NAME="${{ inputs.environment-name }}"
          SECRET_NAME="$ENV_NAME/submit/user-sub-hash-salt"
          SALT_VALUE="${{ inputs.salt-backup-value }}"

          echo "=============================================="
          echo "RESTORE: Salt Secret Value"
          echo "=============================================="
          echo ""

          if [ -z "$SALT_VALUE" ]; then
            echo "ERROR: No salt value provided!"
            echo ""
            echo "Usage: Run this workflow with the 'salt-backup-value' input"
            echo "containing the previously backed-up salt value."
            exit 1
          fi

          VALUE_LEN=${#SALT_VALUE}
          echo "Provided salt value length: $VALUE_LEN characters"

          # Validate length
          if [ $VALUE_LEN -lt 20 ]; then
            echo "ERROR: Salt value seems too short (got $VALUE_LEN, expected ~44)"
            echo "Please verify you're using the correct backup value."
            exit 1
          fi

          echo ""
          echo "Target secret: $SECRET_NAME"

          # Check if secret exists
          if aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${{ env.AWS_REGION }} 2>/dev/null >/dev/null; then
            echo "Secret exists - updating value..."

            aws secretsmanager update-secret \
              --secret-id "$SECRET_NAME" \
              --secret-string "$SALT_VALUE" \
              --region ${{ env.AWS_REGION }}

            echo ""
            echo "Secret updated successfully"
          else
            echo "Secret does not exist - creating..."

            aws secretsmanager create-secret \
              --name "$SECRET_NAME" \
              --description "Salt for hashing user subs - RESTORED from backup" \
              --secret-string "$SALT_VALUE" \
              --region ${{ env.AWS_REGION }} \
              --tags Key=Purpose,Value=user-sub-hashing Key=Critical,Value=true Key=Restored,Value=true Key=RestoredAt,Value="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

            echo ""
            echo "Secret created successfully"
          fi

          echo ""
          echo "=============================================="
          echo "Salt restored successfully!"
          echo "=============================================="
          echo ""
          echo "IMPORTANT: Delete this workflow run from Actions history"
          echo "to remove the salt value from logs."
